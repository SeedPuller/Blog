<!DOCTYPE html><html lang="fa-IR" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="همزمانی در سی++: اشتراک گذاری داده ها(۱)" /><meta name="author" content="سیدپولر" /><meta property="og:locale" content="fa_IR" /><meta name="description" content="یکی از مزایای استفاده از تِرِد ها(threads) این هست که به ما اجازه این رو میده که یک داده واحد رو بین ترد های مختلف به اشتراک بگذاریم. در این فصل به مشکلات مربوط به اشتراک گذاری داده ها و راه‌حل های موجود می‌پردازیم." /><meta property="og:description" content="یکی از مزایای استفاده از تِرِد ها(threads) این هست که به ما اجازه این رو میده که یک داده واحد رو بین ترد های مختلف به اشتراک بگذاریم. در این فصل به مشکلات مربوط به اشتراک گذاری داده ها و راه‌حل های موجود می‌پردازیم." /><link rel="canonical" href="https://www.seedpuller.ir/posts/concurrency-in-cpp-chapter3-1/" /><meta property="og:url" content="https://www.seedpuller.ir/posts/concurrency-in-cpp-chapter3-1/" /><meta property="og:site_name" content="سیدپولر" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-04-01T00:00:00+04:30" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="همزمانی در سی++: اشتراک گذاری داده ها(۱)" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@سیدپولر" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"سیدپولر"},"description":"یکی از مزایای استفاده از تِرِد ها(threads) این هست که به ما اجازه این رو میده که یک داده واحد رو بین ترد های مختلف به اشتراک بگذاریم. در این فصل به مشکلات مربوط به اشتراک گذاری داده ها و راه‌حل های موجود می‌پردازیم.","url":"https://www.seedpuller.ir/posts/concurrency-in-cpp-chapter3-1/","@type":"BlogPosting","headline":"همزمانی در سی++: اشتراک گذاری داده ها(۱)","dateModified":"2021-04-16T00:31:47+04:30","datePublished":"2021-04-01T00:00:00+04:30","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.seedpuller.ir/posts/concurrency-in-cpp-chapter3-1/"},"@context":"https://schema.org"}</script><title>همزمانی در سی++: اشتراک گذاری داده ها(۱) | سیدپولر</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://avatars.githubusercontent.com/u/24620298?s=460&u=dd6165c7d8103164b24d6f40a169594a2c8dac42&v=4" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">سیدپولر</a></div><div class="site-subtitle font-italic">نوشته های مور دانه‌کش</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/SeedPuller" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['SeedPuller','gmail.com'].join('@')" aria-label="email" class="order-4" > <i class="fas fa-envelope"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>همزمانی در سی++: اشتراک گذاری داده ها(۱)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8" style="direction: rtl; text-align: right;"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip style="direction: rtl; text-align: right;">همزمانی در سی++: اشتراک گذاری داده ها(۱)</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, Apr 1, 2021, 12:00 AM +0430" > Apr 1, 2021 <i class="unloaded">2021-04-01T00:00:00+04:30</i> </span> توسط <span class="author"> سیدپولر </span></div><div> <span> بروز شده در <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Fri, Apr 16, 2021, 12:31 AM +0430" > Apr 16, 2021 <i class="unloaded">2021-04-16T00:31:47+04:30</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="حاوی 1790 کلمه"> 9 دقیقه</span></div></div><div class="post-content"><p>یکی از مزایای استفاده از تِرِد ها(threads) این هست که به ما اجازه این رو میده که یک داده واحد رو بین ترد های مختلف به اشتراک بگذاریم. در این فصل به مشکلات مربوط به اشتراک گذاری داده ها و راه‌حل های موجود می‌پردازیم.</p><p>همونطور که قابلیت اشتراک یک داده بین ترد های مختلف در یک پروسه یک فایده بزرگ محسوب می‌شه، میتونه تبدیل به یک مشکل و عقبگرد بزرگ هم باشه. این مسئله که یک داده مشترک بین ترد ها چطور به‌روز بشه، چطور خونده بشه و در مجموع چطور استفاده بشه بسیار مهمه.</p><blockquote><p>بسیاری از باگ های مرتبط به همزمانی(Concurrency) در نرم افزار ها از مدیریت غلط داده های مشترک نشأت می‌گیره!</p></blockquote><h1 id="مشکلات-اشتراک-گذاری-داده-بین-ترد-ها">مشکلات اشتراک گذاری داده بین ترد ها</h1><p>اساسا زمانی مدیریت داده های مشترک برای ما مهم میشه که قرار باشه اون داده ها توسط [یکی] از ترد ها دستکاری بشن. در غیر این صورت، اگر قرار نباشه که داده ویرایش بشه اصلا نیاز نیست خودمون رو بابت این مسئله نگران بکنیم!</p><blockquote><p>اگر داده های ما فقط قراره که خونده بشن،‌ مشکلی نیست!</p></blockquote><p>مشکل از جایی شروع میشه که یکی یا چندتا از ترد ها بخوان سعی کنن چیزی در داده ها بنویسن!</p><p>یکی از مفاهیمی که برنامه‌نویس ها بسیار بهش اتکا می‌کنن، ثابت ها یا Invariant ها هستن، حالا یعنی چی؟</p><p>یک ثابت بخشی از برنامه‌ست که ما به عنوان برنامه نویس انتظار نداریم رفتار غلط از خودش نشون بده. یعنی چی؟ یعنی اگر مثلا یک <span dir="ltr"><code class="language-plaintext highlighter-rouge">&lrm;std::‍vector</code></span>&rlm; داریم، انتظار داریم که تابع <span dir="ltr"><code class="language-plaintext highlighter-rouge">&lrm;size()</code></span>&rlm; به درستی اندازه وکتور رو برای ما برگردونه.</p><p>یا در یک لیست دو پیوندی همیشه انتظار داریم که اشاره‌گر <span dir="ltr"><code class="language-plaintext highlighter-rouge">&lrm;next</code></span>&rlm; به گره بعدی و اشاره‌گر <span dir="ltr"><code class="language-plaintext highlighter-rouge">&lrm;prev</code></span>&rlm; به گره قبلی اشاره بکنه.</p><p>توی خیلی از ساختمان داده ها این ثابت ها در زمان آپدیت شدن ساختمان، دیگه قابل اتکا نیستن. مخصوصا اگه ساختمان داده ما یکم پیچیده باشه یا اینکه هر آپدیتش نیاز به Modify کردن ۲ یا چند بخش مختلف از ساختمان رو داشته باشه.</p><p>اینجا جاییه که مشکل بوجود میاد!</p><p>همون مثال لیست دو پیوندی رو در نظر بگیریم: اگر بخوایم یک گره مثل N رو حذف کنیم، نیازمند این هستیم که گره های قبل و بعدش رو هم آپدیت بکنیم. بنابراین Invariant ها در این ساختمان داده تا زمان اتمام عملیات دیگه قابل اتکا نیستن. یعنی چی؟ یعنی ممکنه زمانی که گره های قبل و بعد از N دارن اصلاح می‌شن، یک ترد دیگه شروع کنه به پیمایش کردن این لیست. حالا دیگه مشخص نیست اون ترد با چی مواجه می‌شه.</p><p>هر نتیجه ای که حاصل بشه، این مثال یکی از چندین سناریو های ممکن برای یکی از متداول ترین باگ ها در کد های همزمان/موازی بود که بهش می‌گن: <strong>Race Condition</strong></p><h2 id="race-condition-ها">Race Condition ها</h2><p>کتاب یک مثال برای توضیح این مورد زده که من یادداشتش نمی‌کنم و صرفا تعریفش در برنامه نویسی(ترد ها) رو می‌نویسم.</p><p>اساسا یک Race condition زمانی بوجود میاد که دو یا چند ترد برای انجام دستورالعمل هاشون باهمدیگه وارد یکجور مسابقه می‌شن. یعنی چی؟ بهتره به مثال لیست دو پیوندی و اعمال حذف کردن و پیمایش لیست توجه کنیم.</p><p>فرض کنیم لیست ما سه عضو داره و یکی از ترد های ما میخواد که عضو شماره ۲ رو حذف کنه. یک ترد دیگه هم هست که میخواد از ابتدای لیست شروع به پیمایش کنه. فرض کنیم حذف کردن یک گره به شکل زیر انجام می‌شه:</p><ol><li><p>پیدا کردن گره N</p><li><p>حذف گره N</p><li><p>اصلاح متغییر <span dir="ltr"><code class="language-plaintext highlighter-rouge">&lrm;prev</code></span>&rlm; مربوط به گره بعدی(برای اینکه حالا باید به گره قبل از N اشاره کنه)</p><li><p>اصلاح متغییر <span dir="ltr"><code class="language-plaintext highlighter-rouge">&lrm;next</code></span>&rlm; مربوط به گره قبلی(برای اینکه باید به گره بعد از N اشاره کنه)</p></ol><p>حالا اگر ترد شماره ۱ هنوز به مرحله ۴ نرسیده باشه، یعنی گره قبل از N هنوز داره به N اشاره می‌کنه. حالا اگر ترد شماره ۲ بیاد و متغییر <span dir="ltr"><code class="language-plaintext highlighter-rouge">&lrm;next</code></span>&rlm; گره قبل از N رو بخونه و بخواد از اون اطلاعات استفاده کنه، یک <em>undefined behavior</em> رخ می‌ده چون به بخشی از حافظه دسترسی گرفته شده که وجود نداره(در مرحله ۲ در ترد شماره ۱ حذف شد!)</p><p>در استاندارد سی++ به اینگونه Race Condition ها که باعث بوجود اومدن مشکل می‌شن با اسم <em>data race</em> اشاره شده.</p><h3 id="دور-ماندن-از-race-condition-ها">دور ماندن از Race condition ها</h3><p>چندین راه برای مدیریت این دست مشکلات وجود داره.</p><p>__راه اول __ ساده ترین و دم دست ترین راه اینه که از ساختمان داده‌مون با یکجور مکانیزم محافظت بکنیم به طوری که فقط اون تردی که داره اعمال ویرایش رو انجام میده در اون لحظه بتونه به ساختمان داده دسترسی داشته باشه و بقیه ترد ها در هنگام ویرایش شدن، نتونن ساختمان داده رو ببینن. بنابراین فقط زمانی میتونن به اطلاعات دسترسی داشته باشن که یا ویرایش تموم شده باشه و یا اصلا شروع نشده باشه. در کتابخانه استاندارد سی++ چندین مکانیزم برای این روش پیاده سازی شده که در همین فصل(فصل ۳ کتاب) بهشون پرداخته شده و من در این پُست و پُست بعدی بهشون می‌پردازم.</p><p><strong>راه دوم:</strong> راه بعدی می‌تونه این باشه که ساختمان داده و اعمالش رو طوری طراحی بکنیم که تغییرات به شکل دنباله‌ای از ویرایش های غیرقابل جدا شدن انجام بشن و به این ترتیب از Invariant ها محافظت کنیم. به این روش اصطلاحا می‌گن <strong>lock-free programming</strong> و همچین هم ساده نیست و نیازمند درک خوبی از مدل حافظه و این‌دست مسائل داره. درباره lock-free programming و مدل حافظه در سی++ به ترتیب در فصل های ۷ و ۵ صحبت شده.</p><p><strong>راه سوم:</strong> یک راه دیگه هم این هست که آپدیت های ساختمان داده رو به شکل «تراکنش» مدیریت کنیم. دقیقا مثل کاری که دیتابیس ها انجام می‌دن. اینطوریه که خواندن/نوشتن یا هرکار دیگه ای روی داده ها که نیازمند چند عمل جداگانه هستن، به شکل واحد جمع می‌شن و یکهو commit می‌شن. اگر به هر دلیلی اون کامیت نتونه به درستی انجام بشه(مثلا بخاطر اینکه ساختمان داده تغییر کرده بوده)، عملیات تراکنش دوباره انجام می‌شه. به این کار هم اصطلاحا می‌گن <strong>Software Transactional Memory</strong> یا <strong>STM</strong>. کتاب درباره این روش صحبتی نکرده و صرفا درباره ایده این عمل به شکل پراکنده حرف زده که در ادامه احتمالا می‌بینیم.</p><p>همونطور که گفتم، ساده ترین راه اینه که یک مکانیزم حفاظتی درست کنیم. این مکانیزم حفاظتی در سی++ به اسم <strong>mutex</strong> شناخته می‌شه.</p><h2 id="حفاظت-از-داده-های-اشتراکگذاری-شده-با-استفاده-از-mutex-ها">حفاظت از داده های اشتراک‌گذاری شده با استفاده از mutex ها</h2><p>ایده کلی mutex چیه؟ اینه که بخش هایی از کد رو طوری علامت بزنیم که اون علامت ها نشون بده آیا درحال حاضر تردی مشغول به کار در اون قسمت هست یا نه. بنابراین وقتی یکی از ترد ها شروع می‌کنه کار کردن با ساختمان داده و این علامت رو فعال(قفل می‌کنه در اصل)، بقیه ترد ها اگر بخوان که به همون قسمت دسترسی داشته باشن باید صبر کنن تا کار ترد قبلی تموم بشه و علامت از حالت قفل به حالت آزاد تغییر پیدا بکنه. یعنی یکجور <em>دسترسی اختصاصی</em> برای ترد ها فراهم می‌کنه.</p><p>این دقیقا کاریه که mutex برای ما انجام می‌ده و عزیزانمون در استاندارد سی++ پیاده سازیش کردن. کافیه که قبل از دسترسی به یک ساختمان داده بیایم و mutex مربوط بهش رو lock کنیم و وقتی که کارمون باهاش تموم شد بیایم و اون mutex رو unlock بکنیم. اینطوری هر ترد دیگه ای که بخواد اقدام به قفل کردن اون mutex بکنه باید صبر کنه که ترد قبلیش mutex مربوطه رو آزاد کنه.</p><p>بله… mutex ها یکی از متداول ترین راه های حفاظت از اطلاعات در یک نرم افزار چند-ترد هستن. اما مهمه که بدونیم همهٔ کار به همین راحتی نیست و صرفا استفاده از mutex مشکل رو حل نمی‌کنه. همچنان نیازمند این هستیم که طراحی کد و اللخصوص interface هامون رو طوری انجام بدیم که امکان race condition ها رو از بین ببریم. همچنین خودِ mutex ها گاهی باعث بوجود اومدن یه مشکل جدید به اسم deadlock می‌شن که باید حواسمون به این هم باشه. تقریبا همهٔ‌ این مسائل رو در ادامه بررسی می‌کنیم (:</p><h3 id="استفاده-از-mutex-ها">استفاده از mutex ها</h3><p>زیاد توضیح نمی‌دم و به نظرم نمایش دادن کد به اندازه کافی می‌تونه گویا باشه. اما گفتن این نکته حائز اهمیته که برای قفل کردن و آزاد کردن(مخصوصا آزاد کردن!) میوتکس ها بهتره که دستی عملی نکنیم. چون در اون صورت باید تمام مسیر هایی که تابع/نرم‌افزار/… دیگه میره رو مدیریت بکنیم. مثلا باید حواسمون باشه که در موقع رخداد یک استثنا باید میوتکس خودمون رو آزاد بکنیم. و خب این کارها طاقت فرساست!</p><p>کتابخونه استاندارد سی++ اومده و <span dir="ltr"><code class="language-plaintext highlighter-rouge">&lrm;std::lock_guard</code></span>&rlm; رو معرفی کرده که با استفاده از مفاهیم <em>RAII</em> میاد و خودش مسئولیت قفل و آزاد کردن mutex رو بر عهده می‌گیره. در موقع ساخته شدن شئ، قفل می‌کنه و در زمان اجرای تابع ویرانگر میاد و میوتکس رو آزاد می‌کنه. کد زیر به اندازه کافی واضح است:</p><div class="language-cpp highlighter-rouge"><div class="highlight" style="direction: ltr; text-align: left;"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre>
<span class="cp">#include &lt;list&gt;
</span>
<span class="cp">#include &lt;mutex&gt;
</span>
<span class="cp">#include &lt;algorithm&gt;
</span>
<span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">some_list</span><span class="p">;</span>

<span class="n">std</span><span class="o">::</span><span class="n">mutex</span> <span class="n">some_mutex</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">add_to_list</span><span class="p">(</span><span class="kt">int</span> <span class="n">new_value</span><span class="p">)</span>

<span class="p">{</span>

    <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">guard</span><span class="p">(</span><span class="n">some_mutex</span><span class="p">);</span>

    <span class="n">some_list</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">new_value</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">bool</span> <span class="nf">list_contains</span><span class="p">(</span><span class="kt">int</span> <span class="n">value_to_find</span><span class="p">)</span>

<span class="p">{</span>

    <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">guard</span><span class="p">(</span><span class="n">some_mutex</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">find</span><span class="p">(</span><span class="n">some_list</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="n">some_list</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="n">value_to_find</span><span class="p">)</span> <span class="o">!=</span> <span class="n">some_list</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>

<span class="p">}</span>

</pre></table></code></span>&rlm;</div></div><p>البته این کد کمی غیر واقعی نمود می‌کنه. ما در دنیای واقعی احتمال زیاد از یک کلاس استفاده می‌کنیم که داده ها(و میوتکس هامون) در قسمت <span dir="ltr"><code class="language-plaintext highlighter-rouge">&lrm;private</code></span>&rlm; کلاس قرار دارن و بخشی از توابع ما که به عنوان اینترفیس کلاس در نظر گرفته می‌شن به در قسمت <span dir="ltr"><code class="language-plaintext highlighter-rouge">&lrm;public</code></span>&rlm; کلاس قرار دارن. حالا آیا اگر ما همین که بیایم و در همه توابعمون میوتکس رو قفل کنیم مشکل رو حل می‌کنه؟ نه.</p><p>همچنان در موقعیت هایی ممکنه کل کد بره روی هوا! مثلا کجا؟ مثلا اگر یکی از توابع بیاد و یک اشاره‌گر به داده‌مون برگردونه :) اون‌وقته که دیگه صدتا میوتکس هم داشته باشیم فایده نداره چون از طریق اون اشاره‌گر میشه هرکاری که دلمون می‌خواد رو انجام بدیم و هیچ کسی هم کاری بهمون نداره. برای همینه که طراحی ساختار خیلی مهمه.</p><h3 id="طراحی-یک-ساختار-مناسب-برای-حفاظت-از-داده-ها">طراحی یک ساختار مناسب برای حفاظت از داده ها</h3><p>همونطور که گفتیم، محافظت از داده ها همچین هم ساده نیست که بیایم و ۴ تا میوتکس استفاده کنیم و اجی مجی لاترجی بشه همه‌چی (:</p><p>بله… چک کردن اینکه آیا اشاره‌گری به داده مورد نظر از کلاس خارج میشه یا نه کار ساده ایه. اما نه اونقدر ها که فکر می‌کنیم (: (آیا زندگی همین نیست؟)</p><p>باید حواسمون باشه که حتی اشاره‌گر به <strong>داخل</strong> تابع دیگه ای(که از محتویاتش خبر نداریم. مثل توابعی که از طریق runtime از کاربر میگیریم) هم پاس داده نشه :) بنابراین یک قاعده کلی داریم که باید در استفاده از mutex ها رعایت کنیم(البته این قاعده کلا به استفاده از شئ‌گرایی هم بر‌می‌گرده چرا که خارج کردن اشاره‌گر، کپسوله‌سازی رو از بین می‌بره):</p><blockquote><p>هیچ اشاره‌گر یا ارجاعی از داده حفاظت شده رو به خارج از بلوک lock شده نفرست! حالا از هر راهی که میخواد باشه.</p></blockquote><p>خب دیگه تبریک می‌گم. فقط همینارو اگه رعایت کنیم دیگه مشکلی نیست.</p><p>آخِی :) چه زود باور.</p><h3 id="مشکل-race-condition-ذاتی-در-اینترفیس-ها">مشکل race condition ذاتی در اینترفیس ها</h3><p>خسته شدم… موکول شد به پُست های بعدی!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/%D8%B3%DB%8C/'>سی++</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/c/" class="post-tag no-text-decoration" >C++</a> <a href="/tags/concurrency-in-action/" class="post-tag no-text-decoration" >concurrency in action</a> <a href="/tags/concurrent-processing/" class="post-tag no-text-decoration" >concurrent processing</a> <a href="/tags/%D9%85%D9%88%D8%A7%D8%B2%DB%8C-%DA%A9%D8%A7%D8%B1%DB%8C/" class="post-tag no-text-decoration" >موازی کاری</a> <a href="/tags/%D9%87%D9%85%D8%B2%D9%85%D8%A7%D9%86%DB%8C/" class="post-tag no-text-decoration" >همزمانی</a> <a href="/tags/%D8%B3%DB%8C/" class="post-tag no-text-decoration" >سی++</a> <a href="/tags/%D8%B3%DB%8C-%DB%B1%DB%B7/" class="post-tag no-text-decoration" >سی++۱۷</a> <a href="/tags/shared-data/" class="post-tag no-text-decoration" >shared data</a> <a href="/tags/mutex/" class="post-tag no-text-decoration" >mutex</a> <a href="/tags/std-mutex/" class="post-tag no-text-decoration" >std::mutex</a> <a href="/tags/%D9%85%DB%8C%D9%88%D8%AA%DA%A9%D8%B3/" class="post-tag no-text-decoration" >میوتکس</a> <a href="/tags/%DA%86%D9%86%D8%AF-%D9%86%D8%AE%DB%8C/" class="post-tag no-text-decoration" >چند نخی</a> <a href="/tags/%D8%A8%D8%B1%D9%86%D8%A7%D9%85%D9%87-%D9%86%D9%88%DB%8C%D8%B3%DB%8C-%DA%86%D9%86%D8%AF-%D9%86%D8%AE%DB%8C/" class="post-tag no-text-decoration" >برنامه نویسی چند نخی</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> این پست تحت مجوز <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> منتشر شده است.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">اشتراک گذاری</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=همزمانی در سی++: اشتراک گذاری داده ها(۱) - سیدپولر&url=https://www.seedpuller.ir/posts/concurrency-in-cpp-chapter3-1/" data-toggle="tooltip" data-placement="top" title="توئیتر" target="_blank" rel="noopener" aria-label="توئیتر"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://telegram.me/share?text=همزمانی در سی++: اشتراک گذاری داده ها(۱) - سیدپولر&url=https://www.seedpuller.ir/posts/concurrency-in-cpp-chapter3-1/" data-toggle="tooltip" data-placement="top" title="تلگرام" target="_blank" rel="noopener" aria-label="تلگرام"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="کپی لینک پست"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/concurrency-in-cpp-chapter1/">همزمانی در سی++: مفاهیم اولیه</a><li><a href="/posts/concurrency-in-cpp-chapter3-5/">همزمانی در سی++(۵): جایگزین های mutex</a><li><a href="/posts/concurrency-in-cpp-chapter3-3/">همزمانی در سی++(۳): Dead Lock ها</a><li><a href="/posts/concurrency-in-cpp-chapter3-4/">همزمانی در سی++(۴): ژانگولر بازی با mutex و کارهای دیگر</a><li><a href="/posts/concurrency-in-cpp-chapter3-1/">همزمانی در سی++: اشتراک گذاری داده ها(۱)</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/c/">C++</a> <a class="post-tag" href="/tags/%D8%B3%DB%8C/">سی++</a> <a class="post-tag" href="/tags/inner-struggle/">Inner Struggle</a> <a class="post-tag" href="/tags/%D8%AF%D8%A7%DB%8C%D8%AA%D9%84/">دایتل</a> <a class="post-tag" href="/tags/%DB%8C%D8%A7%D8%AF%DA%AF%DB%8C%D8%B1%DB%8C/">یادگیری</a> <a class="post-tag" href="/tags/concurrency-in-action/">concurrency in action</a> <a class="post-tag" href="/tags/concurrent-processing/">concurrent processing</a> <a class="post-tag" href="/tags/%D8%A8%D8%B1%D9%86%D8%A7%D9%85%D9%87-%D9%86%D9%88%DB%8C%D8%B3%DB%8C-%DA%86%D9%86%D8%AF-%D9%86%D8%AE%DB%8C/">برنامه نویسی چند نخی</a> <a class="post-tag" href="/tags/%D8%B3%DB%8C-%DB%B1%DB%B7/">سی++۱۷</a> <a class="post-tag" href="/tags/%D9%85%D9%88%D8%A7%D8%B2%DB%8C-%DA%A9%D8%A7%D8%B1%DB%8C/">موازی کاری</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/concurrency-in-cpp-chapter1/"><div class="card-body"> <span class="timeago small" > Sep 24, 2020 <i class="unloaded">2020-09-24T00:00:00+03:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>همزمانی در سی++: مفاهیم اولیه</h3><div class="text-muted small"><p> بالاخره شروع کردم به خوندن کتاب C++ Concurrency in action نوشته Anthony Williams. این کتاب رو باید یک ماه پیش تموم می‌کردم اما مثل همیشه خیلی کند پیش رفتم و فقط ۲ فصلش رو تا الآن خوندم و تازه دارم...</p></div></div></a></div><div class="card"> <a href="/posts/what-i-learned-from-deitel-chapter9/"><div class="card-body"> <span class="timeago small" > Mar 29, 2020 <i class="unloaded">2020-03-29T00:00:00+04:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>از فصل نهم کتاب برنامه نویسی سی++ دایتل چی یادگرفتم</h3><div class="text-muted small"><p> فصل نهم از کتاب C++ How To Program (نگارش ۲۰۱۷) رو تموم کردم و توی این پست نکاتی که از این فصل یادگرفتم(و یادم مونده=) ) رو می‌نویسم. تابع نابودگر (Destructor) علاوه بر ترتیب اجرا شدنش برای اشیاء...</p></div></div></a></div><div class="card"> <a href="/posts/what-ive-learned-from-deitel-chapter10/"><div class="card-body"> <span class="timeago small" > Apr 7, 2020 <i class="unloaded">2020-04-07T00:00:00+04:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>نکاتِ جدیدی که از فصل ۱۰ سی++ دایتل یادگرفتم – نکاتی پراکنده</h3><div class="text-muted small"><p> خب فصل ۱۰ ام از کتاب برنامه نویسی سی++ دایتل رو تموم کردم. اینجا خلاصه ای از چیزای جدیدی که یادگرفتم رو می‌نویسم. string-object literal توی سی++ ۱۴ میشه با اضافه کردن یک s به انتهای لیترال رشته‌ا...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Inner-Struggle2/" class="btn btn-outline-primary" prompt="قبلی"><p>یادداشت بداهه۲</p></a> <a href="/posts/Inner-Struggle-3/" class="btn btn-outline-primary" prompt="بعدی"><p>یادداشت بداهه۳</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div><div class="footer-right" style="direction: rtl; text-align: right;"><p class="mb-0"> <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">مطالب این وبسایت تحت مجوز CC-BY-4.0 منتشر می‌شوند</span></p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/c/">C++</a> <a class="post-tag" href="/tags/%D8%B3%DB%8C/">سی++</a> <a class="post-tag" href="/tags/inner-struggle/">Inner Struggle</a> <a class="post-tag" href="/tags/%D8%AF%D8%A7%DB%8C%D8%AA%D9%84/">دایتل</a> <a class="post-tag" href="/tags/%DB%8C%D8%A7%D8%AF%DA%AF%DB%8C%D8%B1%DB%8C/">یادگیری</a> <a class="post-tag" href="/tags/concurrency-in-action/">concurrency in action</a> <a class="post-tag" href="/tags/concurrent-processing/">concurrent processing</a> <a class="post-tag" href="/tags/%D8%A8%D8%B1%D9%86%D8%A7%D9%85%D9%87-%D9%86%D9%88%DB%8C%D8%B3%DB%8C-%DA%86%D9%86%D8%AF-%D9%86%D8%AE%DB%8C/">برنامه نویسی چند نخی</a> <a class="post-tag" href="/tags/%D8%B3%DB%8C-%DB%B1%DB%B7/">سی++۱۷</a> <a class="post-tag" href="/tags/%D9%85%D9%88%D8%A7%D8%B2%DB%8C-%DA%A9%D8%A7%D8%B1%DB%8C/">موازی کاری</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://www.seedpuller.ir{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
