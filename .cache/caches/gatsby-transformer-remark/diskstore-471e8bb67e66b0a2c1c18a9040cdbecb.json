{"expireTime":9007200880603432000,"key":"transformer-remark-markdown-html-dce4028414b131c5711ccb57573993b9-gatsby-remark-imagesgatsby-remark-audiogatsby-remark-external-linksgatsby-remark-prismjs-","val":"<p>در <a href=\"https://seedpuller.ir/posts/concurrency-in-cpp-chapter3-1/\" target=\"_blank\" rel=\"nofollow\">پست قبل</a> درباره اینکه میوتکس(mutex) ها چی هستن و چطور می‌تونیم ازشون استفاده کنیم صحبت کردیم. رسیدیم به جایی که قرار بود Race Condition هایی که در ذات interface ما وجود داشتن رو پیدا و رفع کنیم :) بریم ببینیم چی میشه.</p>\n<p>این پست رو دارم با ماوس و کیبورد و هدست(که یه موسیقی بی‌کلام ملایم پخش می‌کنم که باهاش صدای بیرون رو نشنوم. درسته که خودش موجب می‌شه تمرکزم کم باشه اما حداقل کافیه که با یه صدا مبارزه کنم نه با صدجور صدای مختلف) جدیدم که دوستای بسیار عزیزم برام خریدن می‌نویسم و بابتش ذوق هم دارم.</p>\n<h2>یافتن Race condition ذاتی در interface ها</h2>\n<p>صرف استفاده از میوتکس ها یا هر مکانیزم حفاظتی دیگه ای دلیل نمیشه که به کلی از race condition ها در امان باشیم. هنوز هم نیاز به انجام اعمال دیگری داریم. یک <code class=\"language-text\">std::stack</code> رو در نظر می‌گیریم که اعمال درونیش(<code class=\"language-text\">push</code> و <code class=\"language-text\">pop</code> و <code class=\"language-text\">top</code> و <code class=\"language-text\">empty</code>) با استفاده از میوتکس حفاظت شده.\nفرض کنیم ترد های ما همچین کدی رو می‌خوان اجرا بکنن:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>s<span class=\"token punctuation\">.</span><span class=\"token function\">empty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">const</span> <span class=\"token keyword\">int</span> value<span class=\"token operator\">=</span>s<span class=\"token punctuation\">.</span><span class=\"token function\">top</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// checkpoint 1</span>\n\ts<span class=\"token punctuation\">.</span><span class=\"token function\">pop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// checkpoint 2</span>\n\t<span class=\"token function\">do_something</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>فرض کنیم داخل استک ما فقط یک عضو وجود داشته باشه و هر دو ترد ما رسیده باشن به <em>checkpoint 1</em>. ترد اول میاد و عملیات <code class=\"language-text\">pop()</code> رو انجام می‌ده. حالا وقتی ترد دوم به <code class=\"language-text\">pop()</code> می‌رسه چه اتفاقی رخ می‌ده؟ مشخصه! <strong>!undefined behavior</strong> </p>\n<p>به این می‌گن یک race condition ذاتی که در رابط یا همون interface وجود داره. حتی اگه lock-free هم برنامه نویسی کرده باشیم باز هم این مشکل پابرجاست و ربطی به میوتکس و ... نداره. مشکل از رابط است.\nراه حلش چیه؟ اینکه بیایم و تغییراتی که میخوایم انجام بدیم رو در یک قدم خلاصه کنیم. یعنی مثلا تابعی داشته باشیم که هم بالاترین عضو پشته رو حذف کنه و هم عضو حذف شده رو برگردونه. چرا خود نویسندگان عزیز کتابخانه استاندارد اینطوری ننوشتن که ما راحت باشیم؟ برای اینکه چیز های دیگه ای مثل Exception Safety هم وجود داره عزیزجان! و دقیقا بخاطر همین مسئله باید این دو کار به شکل جدا از هم انجام بشن! بهرحال برای اینکه ما بتونیم یک اینترفیس امن برای ترد هامون داشته باشیم نیاز داریم که این دو عملیات(<code class=\"language-text\">top</code> و <code class=\"language-text\">pop</code> ) رو یکی کنیم. راه حل چیست؟</p>\n<p><strong>راه اول: پاس دادن یک ارجاع(رفرنس) به تابع</strong></p>\n<p>راه اول اینه که بیایم و یک رفرنس از یک متغییر به تابع بدیم که برامون با محتویات عضوی که میخواد از استک حذف بشه، پُرش کنه.\nمثلا به این شکل:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">std<span class=\"token double-colon punctuation\">::</span>vector<span class=\"token operator\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token operator\">></span> result<span class=\"token punctuation\">;</span>\nsome_stack<span class=\"token punctuation\">.</span><span class=\"token function\">pop</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>البته این راه هم مشکلات خودش رو داره. از جمله اینکه، نیازمند این هست که یک متغییر از نوع متغییر های موجود در استک ساخته بشه(که بتونیم پاسش بدیم). خب این برای Type هایی که ساختنشون منابع زیادی مصرف میشه مناسب نیست. </p>\n<p>محدودیت بعدی اینه که اون Type مورد نظر باید Assignable باشه. </p>\n<p><strong>راه دوم: استفاده از copy/move constructor هایی که استثنا پرتاب نمی‌کنند</strong></p>\n<p>تنها دلیلی که نیاز داریم <code class=\"language-text\">top</code> و <code class=\"language-text\">pop</code> از هم جدا باشن همین مسئله Exception Safety هست. حالا اگر Type ای که می‌خوایم استفاده کنیم دارای Move Constructor و Copy Constructor ای باشه که استثنا(Exception) پرتاب نکنه، دیگه مشکلی نیست و میتونیم به راحتی این دو عملیات رو یکی کنیم.</p>\n<p>بنابراین می‌تونیم این محدودیت رو بذاریم که فقط Type هایی که یکی از سازنده‌های(Constructors) بالا رو دارن قابل استفاده در استک باشن. اما خب این راه هم زیادی محدود کننده‌ست.</p>\n<p><strong>راه سوم: یک اشاره‌گر به آیتمی که حذف می‌شه برگردونیم</strong></p>\n<p>راه سوم اینه که بجای اینکه محتوای آیتم رو کپی کنیم، بیایم و صرفا یک اشاره‌گر از اون آیتم رو برگردونیم و به این ترتیب مشکل استثنا رو حل کنیم چرا که کپی کردن یه پوینتر ایجاد استثنا نمی‌کنه. ولی خب این راه هم مشکلات خودش رو داره:</p>\n<ul>\n<li>باید حواسمون به مدیریت حافظه باشه</li>\n<li>مدیریت حافظه برای Type های کوچیکی مثل Integer ها نمی‌صرفه و فقط بار اضافه‌ست</li>\n</ul>\n<p>برای اولی می‌تونیم از اشاره‌گر های هوشمند استفاده بکنیم؛ مخصوصا <code class=\"language-text\">std::shared_ptr</code> اینجا خیلی میتونه مفید باشه.\nبرای دومی هم میتونیم یه کار دیگه بکنیم؛ اونم اینکه از راه اول یا دوم هم در کنار راه سوم استفاده کنیم (:</p>\n<p>در نهایت کد استک ما این شکلی می‌شه:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;exception></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;memory></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;mutex></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stack></span></span>\n\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">empty_stack</span><span class=\"token operator\">:</span> <span class=\"token base-clause\">std<span class=\"token double-colon punctuation\">::</span><span class=\"token class-name\">exception</span></span>\n<span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> <span class=\"token function\">what</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">throw</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">template</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">typename</span> <span class=\"token class-name\">T</span><span class=\"token operator\">></span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">threadsafe_stack</span>\n<span class=\"token punctuation\">{</span>\n\n<span class=\"token keyword\">private</span><span class=\"token operator\">:</span>\n\tstd<span class=\"token double-colon punctuation\">::</span>stack<span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span> data<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">mutable</span> std<span class=\"token double-colon punctuation\">::</span>mutex m<span class=\"token punctuation\">;</span>\n\t\n<span class=\"token keyword\">public</span><span class=\"token operator\">:</span>\n\t<span class=\"token function\">threadsafe_stack</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\t<span class=\"token function\">threadsafe_stack</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> threadsafe_stack<span class=\"token operator\">&amp;</span> other<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">{</span>\n\t\tstd<span class=\"token double-colon punctuation\">::</span>lock_guard<span class=\"token operator\">&lt;</span>std<span class=\"token double-colon punctuation\">::</span>mutex<span class=\"token operator\">></span> <span class=\"token function\">lock</span><span class=\"token punctuation\">(</span>other<span class=\"token punctuation\">.</span>m<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tdata<span class=\"token operator\">=</span>other<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\t\n\tthreadsafe_stack<span class=\"token operator\">&amp;</span> <span class=\"token keyword\">operator</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> threadsafe_stack<span class=\"token operator\">&amp;</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">delete</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">void</span> <span class=\"token function\">push</span><span class=\"token punctuation\">(</span>T new_value<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">{</span>\n\t\tstd<span class=\"token double-colon punctuation\">::</span>lock_guard<span class=\"token operator\">&lt;</span>std<span class=\"token double-colon punctuation\">::</span>mutex<span class=\"token operator\">></span> <span class=\"token function\">lock</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tdata<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">move</span><span class=\"token punctuation\">(</span>new_value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\t\n\tstd<span class=\"token double-colon punctuation\">::</span>shared_ptr<span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span> <span class=\"token function\">pop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">{</span>\n\t\tstd<span class=\"token double-colon punctuation\">::</span>lock_guard<span class=\"token operator\">&lt;</span>std<span class=\"token double-colon punctuation\">::</span>mutex<span class=\"token operator\">></span> <span class=\"token function\">lock</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span><span class=\"token function\">empty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throw</span> <span class=\"token function\">empty_stack</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tstd<span class=\"token double-colon punctuation\">::</span>shared_ptr<span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span> <span class=\"token keyword\">const</span> <span class=\"token function\">res</span><span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span><span class=\"token generic-function\"><span class=\"token function\">make_shared</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span><span class=\"token function\">top</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tdata<span class=\"token punctuation\">.</span><span class=\"token function\">pop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">return</span> res<span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">void</span> <span class=\"token function\">pop</span><span class=\"token punctuation\">(</span>T<span class=\"token operator\">&amp;</span> value<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">{</span>\n\t\tstd<span class=\"token double-colon punctuation\">::</span>lock_guard<span class=\"token operator\">&lt;</span>std<span class=\"token double-colon punctuation\">::</span>mutex<span class=\"token operator\">></span> <span class=\"token function\">lock</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span><span class=\"token function\">empty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throw</span> <span class=\"token function\">empty_stack</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tvalue<span class=\"token operator\">=</span>data<span class=\"token punctuation\">.</span><span class=\"token function\">top</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tdata<span class=\"token punctuation\">.</span><span class=\"token function\">pop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\t\n\t<span class=\"token keyword\">bool</span> <span class=\"token function\">empty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span>\n\t<span class=\"token punctuation\">{</span>\n\t\tstd<span class=\"token double-colon punctuation\">::</span>lock_guard<span class=\"token operator\">&lt;</span>std<span class=\"token double-colon punctuation\">::</span>mutex<span class=\"token operator\">></span> <span class=\"token function\">lock</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">return</span> data<span class=\"token punctuation\">.</span><span class=\"token function\">empty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>فکر می‌کنم که کد واضح باشه و نیاز به توضیح نیست. بهرحال، در این کد ما از راه اول و سوم باهمدیگه استفاده کردیم (:</p>\n<h2>پایان</h2>\n<p>پُست بعدی هم درباره یک مشکل معروف خواهد بود که یجورایی برعکس Race Condition هست و اصطلاحا بهش می‌گن: Dead Lock</p>\n<p>امروز روز خوبی بود. با اینکه به همه برنامه هام نرسیدم ولی احساسات بدی نداشتم. کاش همه روزا اینطوری باشن!</p>"}